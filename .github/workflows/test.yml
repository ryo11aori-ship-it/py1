name: Test py1 Compiler & Self-Hosting

on: [push, pull_request]

env:
  # 文字化け対策の鉄板設定
  PYTHONIOENCODING: utf-8
  LANG: C.UTF-8

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 1. ブートストラップ（世代1 -> 世代2）
    - name: 1. Bootstrap Generation 1 (py1.py -> compiler_gen2.py)
      run: |
        echo "--- Bootstrapping: py1.py -> compiler.py1 -> compiler_gen2.py ---"
        python py1.py compiler.py1 > compiler_gen2.py
        head -n 5 compiler_gen2.py

    # 2. セルフホスト（世代2 -> 世代3）
    - name: 2. Bootstrap Generation 2 (compiler_gen2.py -> compiler_gen3.py)
      run: |
        echo "--- Self-Hosting: compiler_gen2.py -> compiler.py1 -> compiler_gen3.py ---"
        python compiler_gen2.py compiler.py1 > compiler_gen3.py

    # 3. 冪等性テスト
    - name: 3. Verify Idempotency (Gen2 vs Gen3)
      run: |
        echo "--- Comparing Generation 2 and Generation 3 Code ---"
        if diff -q compiler_gen2.py compiler_gen3.py; then
          echo "SUCCESS: Compiler is idempotent and stable."
        else
          echo "FAILURE: Compiler output differs between generations."
          diff compiler_gen2.py compiler_gen3.py
          exit 1
        fi

    # 4. FizzBuzz
    - name: 4. Application Test (FizzBuzz)
      run: |
        echo "--- Testing FizzBuzz with Gen3 Compiler ---"
        python compiler_gen3.py fizzbuzz.py1 > output_fb.py
        python output_fb.py

    # 5. Unicodeテスト
    - name: 5. Unicode Test
      run: |
        echo "--- Testing Unicode with Gen3 Compiler ---"
        python compiler_gen3.py unicode_test.py1 > output_uni.py
        
        echo "--- Running Unicode Output ---"
        python output_uni.py
