name: Test py1 Compiler & Self-Hosting

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # ステップ1: 元祖コンパイラ(Python製)が動くか確認
    - name: 1. Base Compiler Check (py1.py)
      run: |
        echo "--- Compiling example.py1 with py1.py ---"
        python py1.py example.py1 > output_base.py
        
        echo "--- Running Output ---"
        python output_base.py

    # ステップ2: コンパイラをコンパイルする（ブートストラップ）
    # py1.py (親) -> compiler.py1 (子ソース) -> compiler_bootstrapped.py (子コンパイラ)
    - name: 2. Bootstrap (Compile the Compiler)
      run: |
        echo "--- Bootstrapping: py1.py -> compiler.py1 -> compiler_bootstrapped.py ---"
        python py1.py compiler.py1 > compiler_bootstrapped.py
        
        # 生成されたコンパイラの中身をチラ見せ（デバッグ用）
        echo "--- Generated Compiler Code (First 20 lines) ---"
        head -n 20 compiler_bootstrapped.py
        echo "..."

    # ステップ3: 生まれたての新コンパイラで FizzBuzz をコンパイルしてみる
    # compiler_bootstrapped.py (子) -> fizzbuzz.py1 -> output_fb_v2.py
    - name: 3. Self-Hosted Compiler Test
      run: |
        echo "--- Testing Bootstrapped Compiler ---"
        # ここで python compiler_bootstrapped.py を呼んでいるのがポイント
        python compiler_bootstrapped.py fizzbuzz.py1 > output_fb_v2.py
        
        echo "--- Generated FizzBuzz Code ---"
        cat output_fb_v2.py

    # ステップ4: 最終的に生成されたFizzBuzzが正しく動くか実行
    - name: 4. Run Final FizzBuzz
      run: |
        echo "--- Running Final FizzBuzz ---"
        python output_fb_v2.py
        python py1.py unicode_test.py1 > output_uni.py
        python output_uni.py

